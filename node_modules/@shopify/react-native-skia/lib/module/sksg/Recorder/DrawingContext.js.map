{"version":3,"names":["createDrawingContext","Skia","paintPool","canvas","paints","colorFilters","shaders","imageFilters","pathEffects","paintDeclarations","opacities","nextPaintIndex","Paint","push","savePaint","length","nextPaint","assign","getCurrentPaint","getOpacity","setOpacity","newOpacity","Math","max","min","saveBackdropFilter","imageFilter","imgf","pop","cf","ImageFilter","MakeColorFilter","saveLayer","undefined","restore","restorePaint","materializePaint","setColorFilter","reduceRight","inner","outer","ColorFilter","MakeCompose","setShader","setImageFilter","setPathEffect","PathEffect","paint"],"sources":["DrawingContext.ts"],"sourcesContent":["import type {\n  Skia,\n  SkCanvas,\n  SkColorFilter,\n  SkPaint,\n  SkShader,\n  SkImageFilter,\n  SkPathEffect,\n} from \"../../skia/types\";\n\nexport const createDrawingContext = (\n  Skia: Skia,\n  paintPool: SkPaint[],\n  canvas: SkCanvas\n) => {\n  \"worklet\";\n\n  // State (formerly class fields)\n  const paints: SkPaint[] = [];\n  const colorFilters: SkColorFilter[] = [];\n  const shaders: SkShader[] = [];\n  const imageFilters: SkImageFilter[] = [];\n  const pathEffects: SkPathEffect[] = [];\n  const paintDeclarations: SkPaint[] = [];\n  const opacities: number[] = [];\n\n  let nextPaintIndex = 1;\n\n  // Initialize first paint and opacity\n  paintPool[0] = Skia.Paint();\n  paints.push(paintPool[0]);\n  opacities.push(1);\n\n  // Methods (formerly class methods)\n  const savePaint = () => {\n    // Get next available paint from pool or create new one if needed\n    if (nextPaintIndex >= paintPool.length) {\n      paintPool.push(Skia.Paint());\n    }\n\n    const nextPaint = paintPool[nextPaintIndex];\n    nextPaint.assign(getCurrentPaint()); // Reuse allocation by copying properties\n    paints.push(nextPaint);\n    opacities.push(opacities[opacities.length - 1]);\n    nextPaintIndex++;\n  };\n\n  const getOpacity = () => {\n    return opacities[opacities.length - 1];\n  };\n\n  const setOpacity = (newOpacity: number) => {\n    opacities[opacities.length - 1] = Math.max(0, Math.min(1, newOpacity));\n  };\n\n  const saveBackdropFilter = () => {\n    let imageFilter: SkImageFilter | null = null;\n    const imgf = imageFilters.pop();\n    if (imgf) {\n      imageFilter = imgf;\n    } else {\n      const cf = colorFilters.pop();\n      if (cf) {\n        imageFilter = Skia.ImageFilter.MakeColorFilter(cf, null);\n      }\n    }\n    canvas.saveLayer(undefined, null, imageFilter);\n    canvas.restore();\n  };\n\n  // Equivalent to the `get paint()` getter in the original class\n  const getCurrentPaint = () => {\n    return paints[paints.length - 1];\n  };\n\n  const restorePaint = () => {\n    opacities.pop();\n    return paints.pop();\n  };\n\n  const materializePaint = () => {\n    // Color Filters\n    if (colorFilters.length > 0) {\n      getCurrentPaint().setColorFilter(\n        colorFilters.reduceRight((inner, outer) =>\n          inner ? Skia.ColorFilter.MakeCompose(outer, inner) : outer\n        )\n      );\n    }\n    // Shaders\n    if (shaders.length > 0) {\n      getCurrentPaint().setShader(shaders[shaders.length - 1]);\n    }\n    // Image Filters\n    if (imageFilters.length > 0) {\n      getCurrentPaint().setImageFilter(\n        imageFilters.reduceRight((inner, outer) =>\n          inner ? Skia.ImageFilter.MakeCompose(outer, inner) : outer\n        )\n      );\n    }\n\n    // Path Effects\n    if (pathEffects.length > 0) {\n      getCurrentPaint().setPathEffect(\n        pathEffects.reduceRight((inner, outer) =>\n          inner ? Skia.PathEffect.MakeCompose(outer, inner) : outer\n        )\n      );\n    }\n\n    // Clear arrays\n    colorFilters.length = 0;\n    shaders.length = 0;\n    imageFilters.length = 0;\n    pathEffects.length = 0;\n  };\n\n  // Return an object containing the Skia reference, the canvas, and the methods\n  return {\n    // Public fields\n    Skia,\n    canvas,\n    paints,\n    colorFilters,\n    shaders,\n    imageFilters,\n    pathEffects,\n    paintDeclarations,\n    paintPool,\n\n    // Public methods\n    savePaint,\n    saveBackdropFilter,\n    get paint() {\n      return paints[paints.length - 1];\n    }, // the \"getter\" for the current paint\n    restorePaint,\n    materializePaint,\n    getOpacity,\n    setOpacity,\n  };\n};\n\nexport type DrawingContext = ReturnType<typeof createDrawingContext>;\n"],"mappings":"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","ignoreList":[]}